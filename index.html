<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pembaca Arab Interaktif ‚Äî Init Gemini Otomatis / Fallback Tesseract</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <!-- Tesseract.js untuk fallback OCR lokal -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

  <style>
    html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body.light{background:linear-gradient(180deg,#f4e2a3 0%,#f9f1d1 40%,#fdf9e6 100%);color:#2c2a24;}
    body.dark{background:#071029;color:#e6eef8;}
    .header-controls{position:fixed;top:0;left:0;right:0;padding:12px 16px;z-index:80;background:linear-gradient(180deg,#f4e2a3 0%,#f9f1d1 100%);box-shadow:0 2px 12px rgba(0,0,0,0.08);}
    .book{margin-top:140px;max-width:1100px;margin-left:auto;margin-right:auto;padding:22px;border-radius:10px;background:linear-gradient(180deg,#fff9e5 0%,#fff7d8 100%);box-shadow:0 10px 30px rgba(0,0,0,0.08);}
    .page-paragraph{direction:rtl;text-align:right;font-family:'Amiri',serif;line-height:1.9;word-break:keep-all;}
    .arab-word{display:inline-block;margin:0 .4rem .3rem .2rem;padding:.06rem .28rem;border-radius:8px;cursor:pointer;transition:all .12s;user-select:none;position:relative;}
    .arab-word:hover{transform:translateY(-2px);background:rgba(34,197,94,0.06);}
    .arab-word.is-reading{background:rgba(34,197,94,0.18);font-weight:700;}

    #loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999;color:#fff;flex-direction:column;gap:12px;visibility:hidden;opacity:0;transition:opacity .18s;}
    #loading-overlay.show{visibility:visible;opacity:1;}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    .bubble-dialog-fixed{position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:999;width:90%;max-width:520px;background:#fff;border-radius:12px;padding:14px 18px;box-shadow:0 8px 30px rgba(0,0,0,0.15);}
    body.dark .bubble-dialog-fixed{background:#0b1220;color:#e6eef8;}
    .toast{position:fixed;right:16px;top:16px;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;z-index:3000}
    .toast.green{background:#16a34a;} .toast.red{background:#ef4444;} .toast.orange{background:#f59e0b;}
    .small{font-size:0.9rem}

    /* word-stack styles untuk menampilkan arti di bawah kata */
    .word-stack {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      margin: 0 0.35rem 0.6rem 0.35rem;
      vertical-align: top;
      line-height: 1;
    }
    .word-stack .arab-word { display:inline-block; position:relative; padding:0.06rem .28rem; border-radius:6px; font-family:'Amiri',serif; margin-bottom:0; }
    .word-stack .arab-word:hover { transform:translateY(-2px); }
    .word-meaning {
      display:block; font-size:0.68rem; line-height:1.05; margin-top:0.28rem; max-width:12ch;
      text-align:center; direction:ltr; font-family:system-ui,Arial,sans-serif; color:#065f46;
      background: rgba(255,255,255,0.9); padding:3px 6px; border-radius:6px; box-shadow:0 6px 18px rgba(2,6,23,0.06);
      word-break:break-word; white-space:normal; pointer-events:none; margin-bottom:25px;
    }
    .word-meaning.hidden { display:none !important; }
    body.dark .word-meaning { color:#d1fae5; background: rgba(7,10,19,0.75); box-shadow:0 6px 18px rgba(2,6,23,0.45); }
    @media (max-width:480px) { .word-meaning{font-size:.6rem; max-width:10ch; padding:2px 6px;} .word-stack{margin:0 .25rem .45rem .25rem;} }

  </style>
</head>
<body class="light">
  <div id="app">
    <!-- Loading overlay -->
    <div id="loading-overlay" :class="{ show: loading }" role="status" aria-live="polite">
      <div class="loader" aria-hidden="true"></div>
      <div style="font-weight:700">{{ loadingMessage }}</div>
      <div v-if="debugMode" class="small mt-2 text-yellow-200">DEBUG: periksa console untuk log</div>
    </div>

    <!-- Header -->
    <header class="header-controls">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <!-- Ganti bagian tombol Scan lama dengan ini -->
<div class="flex items-center gap-2">
  <!-- Tombol utama: Camera -->
  <button
    @click="onScanCamera"
    :class="{'opacity-60 cursor-not-allowed': requireApiKeyForOCR && !isApiKeySet}"
    class="px-3 py-1 rounded-lg bg-red-500 text-white flex items-center gap-2"
    title="Ambil foto menggunakan kamera">
    üì∏ Kamera
  </button>

  <!-- Tombol Galeri -->
  <button
    @click="onScanGallery"
    class="px-3 py-1 rounded-lg bg-amber-500 text-white flex items-center gap-2"
    title="Pilih gambar dari galeri">
    üìÅ Galeri
  </button>

  <!-- Hidden inputs: satu dengan capture (kamera), satu tanpa (galeri) -->
  <input id="ocr-upload-camera" type="file" accept="image/*" capture="environment" class="hidden" @change="handleImageUpload">
  <input id="ocr-upload-gallery" type="file" accept="image/*" class="hidden" @change="handleImageUpload">
</div>

          <button @click="openApiKeyModal" class="p-1.5 rounded-full bg-gray-100 ml-2">üîë API Key</button>

          
        </div>

        <div class="flex items-center gap-2">
          <button @click="changeFontSize(2)" class="px-2 py-1 rounded bg-gray-200">A+</button>
          <button @click="changeFontSize(-2)" class="px-2 py-1 rounded bg-gray-200">A-</button>
        </div>
      </div>

      <div class="mt-2 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <label class="flex items-center gap-2"><input type="checkbox" v-model="showArabic"> Harokat</label>
          <label class="flex items-center gap-2"><input type="checkbox" v-model="showMeaning"> Arti</label>
         
        </div>
        
      </div>
    </header>

    <!-- Bubble -->
    <div v-if="activeBubble" class="bubble-dialog-fixed" role="dialog" aria-live="polite">
      <div style="font-family:'Amiri',serif;font-size:2.15rem;text-align:center">{{ activeBubble.item.arab || activeBubble.item }}</div>
      <div class="mt-3 text-sm">
        <p><strong>Arti:</strong> {{ activeBubble.item.arti || '(tidak tersedia)' }}</p><br>
        <p><strong>Kedudukan:</strong> {{ activeBubble.item.kedudukan || '(tidak tersedia)' }}</p>
        <!-- <p class="text-xs mt-1 text-gray-600">Latin: {{ activeBubble.item.latin || '-' }}</p> -->
      </div>
      <div class="mt-3 flex gap-2 justify-center">
        <!-- <button @click="addToMyDictionary(activeBubble.item)" class="px-4 py-1 rounded bg-blue-600 text-white">Simpan</button>
        <button @click="toggleReading(activeBubble.item)" class="px-4 py-1 rounded bg-green-500 text-white"><span v-if="!isSpeaking">üîä Baca</span><span v-else>üîá Berhenti</span></button> -->
        <button @click="closeBubble" class="px-4 py-1 rounded bg-red-500 text-white">Tutup</button>
      </div>
    </div>

    <!-- Dictionary modal -->
    <div v-if="showDictionary" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
      <div class="bg-white w-[92%] max-w-3xl p-4 rounded-lg max-h-[80vh] overflow-auto">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-bold">üìö Kamus Saya ({{ myDictionary.length }})</h3>
          <div class="flex gap-2 items-center">
            <button @click="toggleDictionarySort" class="px-3 py-1 rounded bg-gray-100">Urut: {{ dictionarySortDir === 'desc' ? 'Terbaru ‚Üì' : 'Terlama ‚Üë' }}</button>
            <button @click="showDictionary=false" class="px-3 py-1 rounded bg-red-500 text-white">Tutup</button>
          </div>
        </div>
        <div v-if="myDictionary.length === 0" class="text-center italic text-gray-600">Kamus Anda kosong.</div>
        <div v-else class="space-y-3">
          <div v-for="it in sortedDictionary" :key="it.timestamp" class="p-3 border rounded flex justify-between">
            <div>
              <div style="font-family:'Amiri',serif" class="text-right text-xl">{{ it.arab }} <span class="text-xs text-gray-500">({{ it.noHarokat || '-' }})</span></div>
              <div class="text-sm mt-1"><strong>Arti:</strong> {{ it.arti || '-' }}</div>
              <div class="text-xs text-gray-500 mt-1">Kedudukan: {{ it.kedudukan || '-' }}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button @click="removeFromDictionaryByTimestamp(it.timestamp)" class="text-red-600">Hapus</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- API Key modal -->
    <div v-if="showApiKeyModal" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:100000 !important;" aria-modal="true" role="dialog">
      <div style="background:white; width:92%; max-width:520px; padding:20px; border-radius:12px; box-shadow:0 20px 50px rgba(2,6,23,0.6); z-index:100001;">
        <h3 class="text-lg font-bold mb-2">üîë Masukkan Gemini API Key</h3>
        <p class="text-sm mb-2">Simpan API Key agar aplikasi dapat melakukan OCR & analisis Nahwu otomatis (opsional).</p>

        <input v-model="tempApiKey" type="password" placeholder="API Key" class="w-full p-2 border rounded mb-3" />
        <div class="flex gap-2">
          <button @click="saveApiKey" :disabled="!tempApiKey" class="px-4 py-2 rounded bg-blue-600 text-white">Simpan & Inisialisasi</button>
          <button @click="closeApiKeyModal" class="px-4 py-2 rounded border">Batal</button>
        </div>

        <p class="text-xs text-gray-600 mt-4">Belum punya API Key?
          <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Dapatkan API Key gratis di sini</a>.
        </p>

        <p class="text-xs text-gray-500 mt-2">Catatan: modul Gemini di-load dinamis dari unpkg bila Anda klik Simpan.</p>
      </div>
    </div>

    <!-- Main -->
     <br>
    <div class="book">
      <div class="flex justify-between items-center border-b pb-2 mb-4 mt-4">
        <div class="text-lg font-semibold">Teks Arab Interaktif</div>
        <div><button @click="copyArabicText" :disabled="dataAwal.length===0" class="px-3 py-1 rounded bg-blue-600 text-white">üìã Salin Teks Arab</button></div>
      </div>

      <div v-if="dataAwal.length === 0" class="p-8 text-center text-gray-600 italic">Tekan <strong>Scan Gambar</strong> untuk mengunggah foto teks Arab atau muat hasil sebelumnya.</div>

      <div v-else class="page-paragraph" :style="{ fontSize: fontSizeArabic + 'px' }" aria-live="polite">
        <template v-for="(item, idx) in dataAwal">
          <span class="word-stack" :key="String(idx)" :data-key="String(idx)">
            <span
              class="arab-word rtl-text"
              :class="{
                'is-reading': isSpeaking && activeWordIndex === String(idx),
                'has-meaning': item.arti,
                'bg-yellow-200 dark:bg-yellow-900/50': activeBubble && clickedWordIndex === String(idx),
                'hover:bg-yellow-100 dark:hover:bg-yellow-900/30': true
              }"
              :data-meaning="(item.arti) ? item.arti : ''"
              @click.stop="handleWordClick(item, String(idx), $event)"
              tabindex="0"
              role="button"
              :aria-label="`Kata Arab ${item.arab || item.noHarokat || idx}`"
            >
              {{ showArabic ? (item.arab || item.noHarokat) : (item.noHarokat || item.arab) }}
            </span>

            <small class="word-meaning" :class="{ hidden: !(showMeaning || clickedWordIndex === String(idx)) }" aria-hidden="true">{{ item.arti || '‚Äî' }}</small>
          </span>
        </template>
      </div>
    </div>

    <div v-if="showToast" :class="['toast', toastTypeClass]">{{ toastMessage }}</div>
  </div>

  <script type="module">
    // left intentionally empty; dynamic import occurs inside Vue methods
  </script>

  <script>
  (function () {
    // STORAGE KEYS
    const NAHWU_STORAGE_KEY = 'nahwu_data';
    const API_KEY_STORAGE_KEY = 'geminiApiKey';

    new Vue({
      el: '#app',
      data() {
        return {
          debugMode: true,
          showApiKeyModal: false,
          tempApiKey: '',
          isApiKeySet: !!localStorage.getItem(API_KEY_STORAGE_KEY),
          requireApiKeyForOCR: false, // jika true => user harus masukkan API key sebelum scan
          loading: false,
          loadingMessage: 'Memproses...',
          showToast: false,
          toastMessage: '',
          toastType: 'green',
          theme: localStorage.getItem('theme') || 'light',
          dataAwal: [],
          fontSizeArabic: 24,
          activeBubble: null,
          clickedWordIndex: null,
          myDictionary: JSON.parse(localStorage.getItem('myDictionary') || '[]'),
          showDictionary: false,
          dictionarySortDir: 'desc',
          showArabic: true,
          showMeaning: true,
          ttsMode: 'arab-arti',
          isSpeaking: false,
          activeWordIndex: null,
          aiClient: null
        };
      },
      computed: {
        sortedDictionary() { return this.myDictionary.slice().sort((a,b)=> this.dictionarySortDir==='desc' ? (b.timestamp||0)-(a.timestamp||0) : (a.timestamp||0)-(b.timestamp||0)); },
        toastTypeClass() { return this.toastType==='green' ? 'toast green' : (this.toastType==='red' ? 'toast red' : 'toast orange'); }
      },
      mounted() {
        document.body.className = this.theme;

        // load persisted nahwu_data
        try {
          const saved = localStorage.getItem(NAHWU_STORAGE_KEY);
          if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
              this.dataAwal = parsed;
              this.showToastNotification('Memuat hasil analisis dari penyimpanan lokal.', 'green');
            }
          }
        } catch (e) { console.warn('parse saved nahwu_data', e); }

        // If API key present, try init (non-blocking)
        if (this.isApiKeySet) {
          this.initGeminiClient();
        }
      },
methods: {
  // ---- API Key Modal ----
  openApiKeyModal() {
    this.tempApiKey = localStorage.getItem(API_KEY_STORAGE_KEY) || '';
    this.showApiKeyModal = true;
  },
  closeApiKeyModal() {
    this.showApiKeyModal = false;
    this.tempApiKey = '';
  },

  async saveApiKey() {
    if (!this.tempApiKey) return;
    localStorage.setItem(API_KEY_STORAGE_KEY, this.tempApiKey.trim());
    this.isApiKeySet = true;
    this.showApiKeyModal = false;
    this.showToastNotification('API Key disimpan ‚Äî mencoba inisialisasi...', 'green');
    await this.initGeminiClient();
  },

  async initGeminiClient() {
    const key = localStorage.getItem(API_KEY_STORAGE_KEY);
    if (!key) {
      this.showToastNotification('API Key tidak ditemukan.', 'red');
      return;
    }
    this.loading = true;
    this.loadingMessage = 'Menginisialisasi koneksi AI (Gemini)...';
    try {
      // Dynamic import from unpkg (module)
      const mod = await import('https://unpkg.com/@google/genai?module');
      if (!mod || !mod.GoogleGenAI) throw new Error('Modul genai tidak tersedia dari unpkg');
      this.aiClient = new mod.GoogleGenAI({ apiKey: key });
      console.log('Gemini client initialized:', this.aiClient);
      this.showToastNotification('AI client berhasil diinisialisasi.', 'green');
    } catch (err) {
      console.error('initGeminiClient error:', err);
      this.aiClient = null;
      // keep isApiKeySet true because we did save key; but inform user client init failed
      this.isApiKeySet = true;
      this.showToastNotification('Gagal inisialisasi AI client. OCR lokal akan digunakan.', 'orange');
    } finally {
      this.loading = false;
      this.loadingMessage = 'Memproses...';
    }
  },

  confirmDeleteApiKey() {
    if (confirm('Hapus API Key?')) {
      localStorage.removeItem(API_KEY_STORAGE_KEY);
      this.aiClient = null;
      this.isApiKeySet = false;
      this.showToastNotification('API Key dihapus', 'green');
    }
  },

  // ---- Scan (Camera / Gallery) ----
  onScanCamera() {
    if (this.requireApiKeyForOCR && !this.isApiKeySet) {
      this.showToastNotification('Masukkan API Key dahulu.', 'orange');
      return;
    }
    const input = document.getElementById('ocr-upload-camera') || document.getElementById('ocr-upload');
    if (!input) { console.warn('Input camera not found'); return; }
    input.value = '';
    input.click();
  },

  onScanGallery() {
    if (this.requireApiKeyForOCR && !this.isApiKeySet) {
      this.showToastNotification('Masukkan API Key dahulu.', 'orange');
      return;
    }
    const input = document.getElementById('ocr-upload-gallery') || document.getElementById('ocr-upload');
    if (!input) { console.warn('Input gallery not found'); return; }
    input.value = '';
    input.click();
  },

  // ---- Handle Image Upload (Gemini vision -> JSON nahwu) with Tesseract fallback ----
  async handleImageUpload(event) {
    this.loading = true;
    this.loadingMessage = 'Memproses gambar...';
    console.log('handleImageUpload start');

    const file = event.target.files && event.target.files[0];
    if (!file) {
      this.loading = false;
      this.showToastNotification('File tidak ditemukan.', 'red');
      return;
    }

    // reset UI state
    this.dataAwal = [];
    this.closeBubble();

    // helper untuk simpan & notifikasi
    const persistResults = (arr, note) => {
      this.dataAwal = arr;
      try { localStorage.setItem(NAHWU_STORAGE_KEY, JSON.stringify(arr)); } catch(e) { console.warn(e); }
      this.showToastNotification(note || 'Selesai', 'green');
    };

    try {
      // baca file jadi base64 (untuk Gemini)
      this.loadingMessage = 'Membaca file...';
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || '').split(',')[1] || '');
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      // Jika aiClient tersedia, coba pipeline Gemini (vision -> nahwu JSON)
      if (this.aiClient) {
        try {
          this.loadingMessage = '1/2: Menjalankan OCR (vision) via Gemini...';
          const imagePart = { inlineData: { data: base64, mimeType: file.type } };
          const visionPrompt = "Ekstrak semua teks Arab yang terlihat jelas dari gambar ini. Keluarkan hanya teks Arab mentah, tanpa penjelasan tambahan.";
          const visionResp = await this.aiClient.models.generateContent({
            model: "gemini-2.5-flash",
            contents: [ imagePart, { text: visionPrompt } ],
          });

          let rawArabicText = (visionResp && (visionResp.text || visionResp.output_text ||
            (visionResp.candidates && visionResp.candidates[0] && visionResp.candidates[0].content))) || '';
          rawArabicText = String(rawArabicText).trim();
          console.log('rawArabicText (gemini vision):', rawArabicText);

          if (!rawArabicText) throw new Error('Gemini: teks Arab tidak terdeteksi.');

          // Nahwu -> minta JSON dari Gemini
          this.loadingMessage = "2/2: Menganalisis Nahwu & menghasilkan JSON (Gemini)...";
          const nahwuPrompt = `Analisis teks Arab berikut dan keluarkan HANYA JSON array sesuai format: no, arab, arti (Indonesia, wajib), kedudukan, noHarokat, latin. Teks: """${rawArabicText}"""`;
          const nahwuResp = await this.aiClient.models.generateContent({
            model: "gemini-2.5-flash",
            contents: [{ role: "user", parts: [{ text: nahwuPrompt }] }],
            config: { systemInstruction: "Anda ahli nahwu. Keluaran HARUS berupa JSON array sesuai schema; jangan tambahkan teks lain.", responseMimeType: "application/json" }
          });

          let jsonString = (nahwuResp && (nahwuResp.text || nahwuResp.output_text ||
            (nahwuResp.candidates && nahwuResp.candidates[0] && nahwuResp.candidates[0].content))) || '';
          jsonString = String(jsonString).trim();
          console.log('nahwu json raw:', jsonString);

          // ekstrak substring array JSON jika ada noise
          const first = jsonString.indexOf('[');
          const last = jsonString.lastIndexOf(']');
          if (first !== -1 && last !== -1 && last > first) jsonString = jsonString.slice(first, last + 1);

          const parsed = JSON.parse(jsonString);
          if (!Array.isArray(parsed)) throw new Error('Respons AI bukan array JSON.');

          const normalized = parsed.map((it, i) => ({
            no: it.no || (i+1),
            arab: it.arab || it.noHarokat || '',
            arti: it.arti || '',
            kedudukan: it.kedudukan || '',
            noHarokat: it.noHarokat || it.arab || '',
            latin: it.latin || ''
          }));

          persistResults(normalized, `Analisis Gemini selesai: ${normalized.length} item disimpan.`);
          this.loading = false;
          return;
        } catch (gerr) {
          console.warn('Gemini pipeline failed, fallback to local OCR:', gerr);
          this.showToastNotification('Gemini gagal: menggunakan OCR lokal (fallback).', 'orange');
          // fallthrough to Tesseract below
        }
      } else {
        // jika aiClient belum ada tapi user punya key tersimpan, coba inisialisasi dan lanjutkan (optional)
        if (this.isApiKeySet) {
          try { await this.initGeminiClient(); } catch (e) { /* ignore */ }
          // jika berhasil, kita tidak re-run otomatis; user dapat scan ulang
        }
      }

      // Fallback ke Tesseract.js (OCR lokal)
      this.loadingMessage = 'Melakukan OCR lokal (Tesseract.js)... (mendownload model bila perlu)';
      console.log('Tesseract fallback start');
      const tRes = await Tesseract.recognize(file, 'ara', {
        logger: m => { if (this.debugMode) console.log('Tess log', m); }
      });
      const rawArabicTextLocal = (tRes && tRes.data && tRes.data.text) ? String(tRes.data.text).trim() : '';
      console.log('rawArabicText (tesseract):', rawArabicTextLocal);

      if (!rawArabicTextLocal) throw new Error('OCR lokal gagal mengekstrak teks Arabic.');

      // Sederhanakan menjadi token kata/frasa (Anda bisa mengganti strategi tokenisasi)
      const tokens = rawArabicTextLocal.split(/\s+/).filter(Boolean);
      const arr = tokens.map((tok, i) => ({
        no: i+1,
        arab: tok,
        arti: '',
        kedudukan: '',
        noHarokat: tok,
        latin: ''
      }));

      persistResults(arr, `OCR lokal selesai: ${arr.length} kata/fragmen disimpan.`);
    } catch (err) {
      console.error('error during handleImageUpload:', err);
      this.showToastNotification(err && err.message ? err.message : 'Gagal memproses gambar.', 'red');
      // restore local saved if exist
      const saved = localStorage.getItem(NAHWU_STORAGE_KEY);
      if (saved && !this.dataAwal.length) {
        try { this.dataAwal = JSON.parse(saved); } catch(e){ console.warn(e); }
      }
    } finally {
      this.loading = false;
      this.loadingMessage = 'Memproses...';
      // reset input value agar onchange terpanggil lagi
      const fiCamera = document.getElementById('ocr-upload-camera');
      const fiGallery = document.getElementById('ocr-upload-gallery');
      const fi = document.getElementById('ocr-upload');
      if (fiCamera) fiCamera.value = '';
      if (fiGallery) fiGallery.value = '';
      if (fi) fi.value = '';
      console.log('handleImageUpload finished');
    }
  },

  // ---- Interaksi kata (bubble, highlight) ----
  handleWordClick(item, idx, event) {
    this.clickedWordIndex = idx;
    this.activeBubble = { item };
    try { if (event && event.currentTarget && typeof event.currentTarget.focus === 'function') event.currentTarget.focus(); } catch (e) {}
  },
  closeBubble() {
    this.activeBubble = null;
    this.clickedWordIndex = null;
    this.activeWordIndex = null;
  },

  // ---- TTS ----
  toggleReading(item = null) {
    if (this.isSpeaking) { try { window.speechSynthesis.cancel(); } catch(e){} this.isSpeaking = false; this.activeWordIndex = null; return; }
    const arr = item ? [item] : this.dataAwal;
    if (!arr || arr.length === 0) return this.showToastNotification('Tidak ada teks untuk dibaca.', 'orange');
    this.startReading(arr);
  },

  startReading(data) {
    this.isSpeaking = true;
    let current = 0;
    const voices = window.speechSynthesis.getVoices();
    const arabVoice = voices.find(v => v.lang && v.lang.startsWith('ar')) || voices.find(v => /Arabic/i.test(v.name));
    const idVoice = voices.find(v => v.lang && v.lang.startsWith('id')) || voices.find(v => /Indonesian/i.test(v.name));
    const speakOne = () => {
      if (!this.isSpeaking || current >= data.length) { this.isSpeaking = false; this.activeWordIndex = null; return; }
      const item = data[current];
      const globalIndex = this.dataAwal.findIndex(d => d.no === item.no && d.arab === item.arab);
      this.activeWordIndex = globalIndex !== -1 ? String(globalIndex) : null;
      let text = '', voice = null;
      if (this.ttsMode === 'arab-arti') { text = (item.arab ? item.arab + '. ' : '') + (item.arti ? ('Artinya: ' + item.arti) : ''); voice = arabVoice || idVoice; }
      else if (this.ttsMode === 'arti') { text = item.arti || ''; voice = idVoice; }
      else { text = item.arab || item.noHarokat || ''; voice = arabVoice; }
      if (!text) { current++; speakOne(); return; }
      const u = new SpeechSynthesisUtterance(text);
      if (voice) { u.voice = voice; u.lang = voice.lang || (this.ttsMode.includes('arab') ? 'ar-SA' : 'id-ID'); } else u.lang = this.ttsMode.includes('arab') ? 'ar-SA' : 'id-ID';
      u.onend = () => { current++; speakOne(); };
      u.onerror = () => { current++; speakOne(); };
      try { window.speechSynthesis.speak(u); } catch (e) { console.error(e); current++; speakOne(); }
    };
    try { window.speechSynthesis.cancel(); } catch (e) {}
    speakOne();
  },

  // ---- Kamus ----
  addToMyDictionary(item) {
    if (!item || !item.arab) return;
    if (this.myDictionary.some(d => d.arab === item.arab)) return this.showToastNotification('Sudah ada di kamus', 'orange');
    const ni = { ...item, timestamp: Date.now() };
    this.myDictionary.unshift(ni);
    localStorage.setItem('myDictionary', JSON.stringify(this.myDictionary));
    this.showToastNotification('Disimpan ke kamus', 'green');
  },

  removeFromDictionaryByTimestamp(ts) {
    const idx = this.myDictionary.findIndex(d => d.timestamp === ts);
    if (idx !== -1 && confirm('Hapus kata ini dari kamus?')) {
      this.myDictionary.splice(idx, 1);
      localStorage.setItem('myDictionary', JSON.stringify(this.myDictionary));
      this.showToastNotification('Terhapus', 'green');
    }
  },

  toggleDictionarySort() {
    this.dictionarySortDir = this.dictionarySortDir === 'desc' ? 'asc' : 'desc';
  },

  // ---- UI helpers ----
  toggleTheme() {
    this.theme = this.theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', this.theme);
    document.body.className = this.theme;
  },

  changeFontSize(delta) {
    this.fontSizeArabic = Math.max(14, this.fontSizeArabic + delta);
  },

  copyArabicText() {
    const txt = this.dataAwal.map(d => d.arab || d.noHarokat).join(' ');
    navigator.clipboard.writeText(txt).then(() => this.showToastNotification('Teks Arab disalin', 'green')).catch(() => this.showToastNotification('Gagal menyalin', 'red'));
  },

  confirmDeleteApiKey() {
    if (confirm('Hapus API Key?')) {
      localStorage.removeItem(API_KEY_STORAGE_KEY);
      this.aiClient = null;
      this.isApiKeySet = false;
      this.showToastNotification('API Key dihapus', 'green');
    }
  },

  // ---- Toast helper ----
  showToastNotification(message, type = 'green') {
    this.toastMessage = message;
    this.toastType = type;
    this.showToast = true;
    clearTimeout(this._toastTimer);
    this._toastTimer = setTimeout(() => this.showToast = false, 3500);
  }
}

    });
  })();
  </script>
</body>
</html>
